{% extends "base.html" %}
{% block content %}
  <h2 class="mb-4">üìä Dashboard</h2>

  <!-- Summary Cards -->
  <div class="row mb-4">
    <div class="col-md-4">
      <div class="card text-white bg-success mb-3">
        <div class="card-body text-center">
          <h5 class="card-title">Total CO‚ÇÇ This Week</h5>
          <p class="card-text fs-4">{{ total }} kg</p>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card text-white bg-primary mb-3">
        <div class="card-body text-center">
          <h5 class="card-title">Electricity</h5>
          <p class="card-text fs-5">{{ electricity }} kg</p>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card text-white bg-warning mb-3">
        <div class="card-body text-center">
          <h5 class="card-title">Travel</h5>
          <p class="card-text fs-5">{{ travel }} kg</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Weekly Goal Tracker -->
  <div class="card mb-4">
    <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
      <span>üåç Weekly CO‚ÇÇ Goal</span>
      <a href="{{ url_for('settings') }}" class="btn btn-sm btn-outline-light">Set Weekly Goal</a>
    </div>
    <div class="card-body">
      <p>You‚Äôve used <strong>{{ total }} kg</strong> of your <strong>{{ goal }} kg</strong> weekly target.</p>
      <div class="progress" style="height: 25px;">
        <div class="progress-bar 
             {% if progress < 50 %}bg-success
             {% elif progress < 80 %}bg-warning
             {% else %}bg-danger{% endif %}" 
             role="progressbar" 
             style="width: {{ progress }}%;">
          {{ progress }}%
        </div>
      </div>
      <p class="mt-2">{{ message if message is defined else '' }}</p>
    </div>
  </div>

  <!-- Achievement Badges -->
  {% if badges %}
  <div class="card mb-4">
    <div class="card-header bg-info text-dark">üèÖ Achievements</div>
    <div class="card-body">
      <ul class="list-group">
        {% for badge in badges %}
          <li class="list-group-item">{{ badge }}</li>
        {% endfor %}
      </ul>
    </div>
  </div>
  {% endif %}

  <!-- Small Export Links -->
  <p class="text-muted">
    Need a copy? Download your 
    <a href="{{ url_for('export_csv') }}">CSV</a> or 
    <a href="{{ url_for('export_pdf') }}">PDF</a> report.
  </p>

  <!-- Recent Activities Table -->
  <h3 class="mb-3">üìù Recent Activities</h3>
  {% if entries %}
    <div class="table-responsive">
      <table class="table table-bordered table-hover align-middle">
        <thead class="table-success">
          <tr>
            <th>Date</th>
            <th>Travel</th>
            <th>KMs</th>
            <th>kWh</th>
            <th>Diet</th>
            <th>CO‚ÇÇ (kg)</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for e in entries %}
            <tr>
              <td>{{ e.date }}</td>
              <td>{{ e.travel_mode }}</td>
              <td>{{ e.travel_km }}</td>
              <td>{{ e.electricity_kwh }}</td>
              <td>{{ e.diet_type }}</td>
              <td class="fw-bold">{{ "%.2f"|format(e.co2_kg) }}</td>
              <td style="white-space:nowrap;">
                <a href="{{ url_for('edit_activity', act_id=e.id) }}" class="btn btn-sm btn-outline-primary me-1">Edit</a>
                <form method="POST" action="{{ url_for('delete_activity', act_id=e.id) }}" style="display:inline;" onsubmit="return confirm('Delete this activity?');">
                  <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
                </form>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <div class="alert alert-info">No activities logged yet.</div>
  {% endif %}

  <!-- Charts Section -->
  <h3 class="mb-3">üìà CO‚ÇÇ Analytics</h3>
  <div class="row">
    <div class="col-md-6 mb-4">
      <div class="card">
        <div class="card-header bg-success text-white">Weekly CO‚ÇÇ Emissions</div>
        <div class="card-body">
          <canvas id="lineChart" height="250"></canvas>
        </div>
      </div>
    </div>
    <div class="col-md-6 mb-4">
      <div class="card">
        <div class="card-header bg-success text-white">CO‚ÇÇ Breakdown</div>
        <div class="card-body">
          <canvas id="pieChart" height="250"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // Line Chart
    new Chart(document.getElementById('lineChart'), {
      type: 'line',
      data: {
        labels: {{ chart_labels|safe }},
        datasets: [{
          label: 'CO‚ÇÇ (kg)',
          data: {{ chart_values|safe }},
          borderColor: '#2e7d32',
          backgroundColor: 'rgba(46,125,50,0.2)',
          fill: true,
          tension: 0.3
        }]
      }
    });

    // Pie Chart
    new Chart(document.getElementById('pieChart'), {
      type: 'pie',
      data: {
        labels: ['Travel', 'Electricity', 'Diet'],
        datasets: [{
          data: [{{ travel }}, {{ electricity }}, {{ diet }}],
          backgroundColor: ['#FF9800', '#2196F3', '#9C27B0']
        }]
      }
    });
  </script>
{% endblock %}
